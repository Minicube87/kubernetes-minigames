<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Memory - Meme Match</title>
    <style>
      :root {
        color-scheme: light;
        --bg: #0f172a;
        --panel: #111827;
        --card: #1f2937;
        --card-face: #f9fafb;
        --accent: #f97316;
        --accent-2: #22c55e;
        --text: #e5e7eb;
        --muted: #94a3b8;
      }
      * {
        box-sizing: border-box;
      }
      html, body {
        margin: 0;
        padding: 0;
        min-height: 100%;
        background: radial-gradient(circle at top, #1f2937, var(--bg));
        font-family: "Trebuchet MS", "Segoe UI", sans-serif;
        color: var(--text);
        touch-action: pan-y;
        overscroll-behavior: contain;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }
      .wrap {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        gap: 16px;
        padding: 16px;
        padding-bottom: calc(16px + env(safe-area-inset-bottom));
      }
      header {
        background: var(--panel);
        border-radius: 16px;
        padding: 16px;
        box-shadow: 0 18px 40px rgba(0, 0, 0, 0.35);
      }
      h1 {
        margin: 0 0 8px;
        font-size: 1.4rem;
        letter-spacing: 0.04em;
      }
      p {
        margin: 0 0 8px;
        color: var(--muted);
      }
      .grid {
        display: grid;
        gap: 12px;
        grid-template-columns: 1fr;
      }
      .panel {
        background: var(--panel);
        padding: 12px;
        border-radius: 16px;
        box-shadow: 0 18px 40px rgba(0, 0, 0, 0.3);
      }
      .controls {
        display: grid;
        gap: 10px;
      }
      .field {
        display: grid;
        gap: 4px;
        font-size: 0.85rem;
        color: var(--muted);
      }
      input, select, button {
        font: inherit;
        border-radius: 10px;
        border: none;
        padding: 10px 12px;
      }
      input, select {
        background: #0f172a;
        color: var(--text);
        border: 1px solid #1f2937;
      }
      button {
        background: var(--accent);
        color: #111827;
        font-weight: 700;
        letter-spacing: 0.03em;
      }
      button.secondary {
        background: #334155;
        color: var(--text);
      }
      .stats {
        display: grid;
        gap: 8px;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        font-size: 0.9rem;
      }
      .stat {
        padding: 8px 12px;
        background: #0f172a;
        border-radius: 10px;
        border: 1px solid #1f2937;
      }
      .board {
        display: grid;
        gap: 10px;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        margin-top: 12px;
      }
      .card {
        position: relative;
        padding-top: 110%;
        perspective: 1000px;
      }
      .card-inner {
        position: absolute;
        inset: 0;
        border-radius: 12px;
        transform-style: preserve-3d;
        transition: transform 0.3s ease;
      }
      .card.revealed .card-inner,
      .card.matched .card-inner {
        transform: rotateY(180deg);
      }
      .face {
        position: absolute;
        inset: 0;
        display: grid;
        place-items: center;
        border-radius: 12px;
        backface-visibility: hidden;
        padding: 8px;
        text-align: center;
      }
      .face.back {
        background: linear-gradient(145deg, #1f2937, #0b1220);
        border: 2px solid #334155;
        color: var(--muted);
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }
      .face.front {
        background: var(--card-face);
        color: #111827;
        transform: rotateY(180deg);
        border: 2px solid #e2e8f0;
      }
      .meme-title {
        font-family: Impact, "Arial Black", sans-serif;
        font-size: 0.78rem;
        text-transform: uppercase;
        letter-spacing: 0.04em;
      }
      .meme-sub {
        margin-top: 6px;
        font-size: 0.65rem;
        color: #334155;
      }
      .matched .face.front {
        border-color: var(--accent-2);
        box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.4);
      }
      .footer {
        font-size: 0.8rem;
        color: var(--muted);
        text-align: center;
      }
      @media (min-width: 700px) {
        .wrap {
          max-width: 920px;
          margin: 0 auto;
        }
        .grid {
          grid-template-columns: 320px 1fr;
        }
        .board {
          grid-template-columns: repeat(5, minmax(0, 1fr));
        }
      }
      @media (max-width: 480px) {
        .panel {
          padding: 12px;
        }
        .stats {
          grid-template-columns: 1fr 1fr;
          gap: 6px;
        }
        button {
          padding: 12px 14px;
        }
        .card {
          padding-top: 115%;
        }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <header>
        <h1>Meme Match (Async 2-Player)</h1>
        <p>Use the same room code to get the same deck. Play anytime, compare scores later.</p>
      </header>

      <div class="grid">
        <section class="panel controls">
          <label class="field">
            Room code
            <input id="roomCode" placeholder="e.g. DOGE42" />
          </label>
          <label class="field">
            Player name
            <input id="playerName" placeholder="e.g. Alex" />
          </label>
          <label class="field">
            Board size
            <select id="boardSize">
              <option value="8">8 pairs (4x4)</option>
              <option value="10">10 pairs (4x5)</option>
            </select>
          </label>
          <label class="field">
            Theme
            <select id="theme">
              <option value="classic">Classic Meme Mix</option>
              <option value="kirk">Charlie Kirk Face</option>
              <option value="insta">Insta GIF Cringe</option>
            </select>
          </label>
          <button id="startBtn">Start / Reset</button>
          <button id="newCodeBtn" class="secondary">Generate new code</button>
          <button id="copyCodeBtn" class="secondary">Copy share text</button>
        </section>

        <section class="panel">
          <div class="stats">
            <div class="stat" id="turnInfo">Turn: -</div>
            <div class="stat" id="moves">Moves: 0</div>
            <div class="stat" id="timer">Time: 0s</div>
            <div class="stat" id="matches">Matches: 0</div>
          </div>
          <div class="board" id="board"></div>
        </section>
      </div>

      <div class="footer">Async mode: your score is saved locally on this device for the room code.</div>
    </div>

    <script>
      const themes = {
        classic: [
          { title: "DOGE", sub: "wow such memory" },
          { title: "THIS IS FINE", sub: "everything is fine" },
          { title: "RICKROLL", sub: "never gonna give" },
          { title: "DISTRACTED BF", sub: "classic move" },
          { title: "BLINKING GUY", sub: "wait what" },
          { title: "PEPE", sub: "feels good" },
          { title: "SALT BAE", sub: "seasoned" },
          { title: "SUCCESS KID", sub: "we got this" },
          { title: "FUTURAMA FRY", sub: "not sure if" },
          { title: "GALAXY BRAIN", sub: "big brain" },
          { title: "GRUMPY CAT", sub: "nope" },
          { title: "KAREN", sub: "I want manager" },
        ],
        kirk: [
          { title: "TINY FACE", sub: "debate mode" },
          { title: "WIDE STARE", sub: "camera zoom" },
          { title: "OPEN MOUTH", sub: "soundbite time" },
          { title: "POINTING", sub: "gotcha moment" },
          { title: "SMIRK", sub: "clip incoming" },
          { title: "LOOK LEFT", sub: "ignore facts" },
          { title: "LOOK RIGHT", sub: "pivot hard" },
          { title: "HEAD TILT", sub: "confidently wrong" },
          { title: "ECHO CHAMBER", sub: "applause sign" },
          { title: "MIC DROP", sub: "not really" },
          { title: "HOT TAKE", sub: "extra spicy" },
          { title: "SHOCK FACE", sub: "viral moment" },
        ],
        insta: [
          { title: "CAPTION: OMG", sub: "gif energy" },
          { title: "REACTION LOOP", sub: "send it" },
          { title: "SAD SPARKLE", sub: "mood" },
          { title: "HYPE DANCE", sub: "we vibing" },
          { title: "EYE ROLL", sub: "cringe detected" },
          { title: "ZOOM IN", sub: "dramatic" },
          { title: "KISSY FACE", sub: "story time" },
          { title: "PET FILTER", sub: "meow" },
          { title: "GLITCH CUT", sub: "loop it" },
          { title: "LOW QUALITY", sub: "intentional" },
          { title: "SLO MO", sub: "cinematic" },
          { title: "TEXT OVERLAY", sub: "POV: you" },
        ],
      };

      const roomCodeInput = document.getElementById("roomCode");
      const playerNameInput = document.getElementById("playerName");
      const boardSizeInput = document.getElementById("boardSize");
      const themeInput = document.getElementById("theme");
      const boardEl = document.getElementById("board");
      const startBtn = document.getElementById("startBtn");
      const newCodeBtn = document.getElementById("newCodeBtn");
      const copyCodeBtn = document.getElementById("copyCodeBtn");
      const movesEl = document.getElementById("moves");
      const timerEl = document.getElementById("timer");
      const matchesEl = document.getElementById("matches");
      const turnEl = document.getElementById("turnInfo");

      let state = {
        deck: [],
        revealed: [],
        matched: new Set(),
        moves: 0,
        matches: 0,
        timer: 0,
        timerId: null,
        started: false,
        roomCode: "",
        playerName: "",
        pairs: 8,
        theme: "classic",
      };

      function hashString(str) {
        let h = 1779033703 ^ str.length;
        for (let i = 0; i < str.length; i++) {
          h = Math.imul(h ^ str.charCodeAt(i), 3432918353);
          h = (h << 13) | (h >>> 19);
        }
        return () => {
          h = Math.imul(h ^ (h >>> 16), 2246822507);
          h = Math.imul(h ^ (h >>> 13), 3266489909);
          return (h ^= h >>> 16) >>> 0;
        };
      }

      function mulberry32(seed) {
        return () => {
          let t = (seed += 0x6d2b79f5);
          t = Math.imul(t ^ (t >>> 15), t | 1);
          t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
          return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
        };
      }

      function seededShuffle(items, seedStr) {
        const seedFn = hashString(seedStr);
        const rand = mulberry32(seedFn());
        const arr = items.slice();
        for (let i = arr.length - 1; i > 0; i--) {
          const j = Math.floor(rand() * (i + 1));
          [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
      }

      function buildDeck(pairs, seedStr, themeKey) {
        const theme = themes[themeKey] || themes.classic;
        const picks = seededShuffle(theme, seedStr).slice(0, pairs);
        const doubled = picks.concat(picks).map((item, idx) => ({
          id: `${item.title}-${idx}`,
          title: item.title,
          sub: item.sub,
        }));
        return seededShuffle(doubled, seedStr + "-deck");
      }

      function renderBoard() {
        boardEl.innerHTML = "";
        state.deck.forEach((card, index) => {
          const cardEl = document.createElement("button");
          cardEl.className = "card";
          cardEl.setAttribute("aria-label", `Card ${index + 1}`);
          cardEl.innerHTML = `
            <div class="card-inner">
              <div class="face back">MEME</div>
              <div class="face front">
                <div class="meme-title">${card.title}</div>
                <div class="meme-sub">${card.sub}</div>
              </div>
            </div>
          `;
          cardEl.addEventListener("click", () => {
            handleFlip(index, cardEl);
          });
          boardEl.appendChild(cardEl);
        });
        adjustBoardColumns();
      }

      function adjustBoardColumns() {
        const pairs = state.pairs;
        const columns = pairs <= 8 ? 4 : 5;
        boardEl.style.gridTemplateColumns = `repeat(${columns}, minmax(0, 1fr))`;
      }

      function handleFlip(index, cardEl) {
        if (!state.roomCode || !state.playerName) {
          alert("Please enter room code and player name first.");
          return;
        }
        if (state.revealed.length === 2) {
          return;
        }
        if (state.matched.has(index) || state.revealed.includes(index)) {
          return;
        }
        if (!state.started) {
          startTimer();
        }
        state.revealed.push(index);
        cardEl.classList.add("revealed");

        if (state.revealed.length === 2) {
          state.moves += 1;
          const [first, second] = state.revealed;
          const firstCard = state.deck[first];
          const secondCard = state.deck[second];
          if (firstCard.title === secondCard.title) {
            state.matched.add(first);
            state.matched.add(second);
            state.matches += 1;
            markMatched();
            state.revealed = [];
            if (state.matches === state.pairs) {
              finishGame();
            }
          } else {
            setTimeout(() => {
              resetRevealed();
            }, 650);
          }
          updateStats();
        }
      }

      function markMatched() {
        state.matched.forEach((idx) => {
          const card = boardEl.children[idx];
          card.classList.add("matched");
        });
      }

      function resetRevealed() {
        state.revealed.forEach((idx) => {
          const card = boardEl.children[idx];
          card.classList.remove("revealed");
        });
        state.revealed = [];
      }

      function updateStats() {
        movesEl.textContent = `Moves: ${state.moves}`;
        matchesEl.textContent = `Matches: ${state.matches}`;
        turnEl.textContent = `Player: ${state.playerName || "-"}`;
      }

      function startTimer() {
        state.started = true;
        if (state.timerId) {
          clearInterval(state.timerId);
        }
        state.timerId = setInterval(() => {
          state.timer += 1;
          timerEl.textContent = `Time: ${state.timer}s`;
        }, 1000);
      }

      function stopTimer() {
        if (state.timerId) {
          clearInterval(state.timerId);
        }
        state.timerId = null;
      }

      function finishGame() {
        stopTimer();
        saveResult();
        setTimeout(() => {
          alert(`Finished! ${state.playerName} needed ${state.moves} moves in ${state.timer}s.`);
        }, 120);
      }

      function saveResult() {
        if (!state.roomCode || !state.playerName) {
          return;
        }
        const key = `memory:${state.roomCode}:${state.playerName}`;
        const payload = {
          room: state.roomCode,
          player: state.playerName,
          moves: state.moves,
          time: state.timer,
          pairs: state.pairs,
          date: new Date().toISOString(),
        };
        localStorage.setItem(key, JSON.stringify(payload));
      }

      function resetGame() {
        state.revealed = [];
        state.matched = new Set();
        state.moves = 0;
        state.matches = 0;
        state.timer = 0;
        state.started = false;
        stopTimer();
        timerEl.textContent = "Time: 0s";
        updateStats();
        renderBoard();
      }

      function generateCode() {
        const words = ["DOGE", "MEME", "LOL", "WUT", "YOLO", "HYPE", "PEPE", "KAPPA"];
        const word = words[Math.floor(Math.random() * words.length)];
        const number = Math.floor(10 + Math.random() * 90);
        return `${word}${number}`;
      }

      function startGame() {
        const room = roomCodeInput.value.trim().toUpperCase();
        const player = playerNameInput.value.trim();
        const pairs = Number(boardSizeInput.value);
        const themeKey = themeInput.value;
        if (!room) {
          alert("Please enter a room code.");
          return;
        }
        if (!player) {
          alert("Please enter your name.");
          return;
        }
        state.roomCode = room;
        state.playerName = player;
        state.pairs = pairs;
        state.theme = themeKey;
        const seedStr = `${room}-${pairs}-${themeKey}-v1`;
        state.deck = buildDeck(pairs, seedStr, themeKey);
        resetGame();
      }

      startBtn.addEventListener("click", startGame);

      newCodeBtn.addEventListener("click", () => {
        roomCodeInput.value = generateCode();
      });

      copyCodeBtn.addEventListener("click", () => {
        const room = roomCodeInput.value.trim().toUpperCase();
        if (!room) {
          alert("Enter a room code first.");
          return;
        }
        const text = `Play Meme Match. Room: ${room}. Open http://raspberrypi.fritz.box/memory`; 
        navigator.clipboard.writeText(text).then(() => {
          alert("Share text copied.");
        }).catch(() => {
          alert(text);
        });
      });

      roomCodeInput.value = generateCode();
      updateStats();
    </script>
  </body>
</html>
